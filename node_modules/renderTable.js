/*
 * renderTable - converts SQLite row output into HTML tables
 *
 * usage: 
 *
 *	htmlString = require('renderTable').tableToHTML(rows);
 *
 *
 *
 */

var jaml = require('jaml');

/*
 * Various Jaml templates to accepted the array structure created by
 * 	getHeader(), getData(), and tableToHTML()
 *
 *
 */


/* Jaml.render('tableheader', header)
 * returns a string = "<th>" + header + "</th>"
 * or, in the case that header is an array
 *	string = "<th>" + header[0] + "</th>"
 *		+ "<th>" + header[1] + "</th>"
 *		...
 *		+ "<th>" + header[n] + "</th>"
 */
Jaml.register('tableheader', function(header){
	th(header.toString());
});

/* Jaml.render('tablerow', row)
 * returns a string = "<tr>" + ...rendered <td></td> cell...  + "</tr>"
 * or, in the case that row is an array, multiple rows are rendered
 * as above.
 */
Jaml.register('tablerow', function(row){
	tr(Jaml.render('tablecell', row));
});

/* Jaml.render('tablecell', cell)
 * returns a string = "<td>" + cell + "</td>"
 * or, in the case that cell is an array, multiple cells are rendered
 * as above.
 */
Jaml.register('tablecell', function(cell){
	td(cell.toString());
});

/* Jaml.render('table', input)
 * Receives an object of the form input = {head: String[]; rows: String[][]}
 * A table is rendered from this, applying the above Jaml templates.
 */
Jaml.register('table', function(input)	{
	table({border:1,cellpadding:1},
		tr(Jaml.render('tableheader', input.head)),
		Jaml.render('tablerow', input.rows)
	);
});


/*
 * getHeader(row)
 *	extracts from row, the SQLite output, and extracts column names
 *	returning them in a array of strings.
 *
 */

exports.getHeader = function(row) {
	var header = [];

	for (var key in row[0]){
		header[header.length] = key;
	}
	
	return header;
}

/*
 * getData(row)
 *	extracts from row, the SQLite output, and extracts data
 *	and creates an array from each row, returning an array of these 
 * 	arrays.
 *
 */

exports.getData = function(row){
	var data = [[]];
	var i,j;
	
	for (i = 0; i < row.length; i++){
		data[i] = [];
		for (j in row[i]){
			data[i][data[i].length] = row[i][j];
		}
	}

	return data;
}

/*
 * tableToHTML(row)
 * 	uses getHeader() and getData() to extract the data from
 *	the SQLite output and submits it to the Jaml templates
 *	to be rendered into an HTML table.
 */
exports.tableToHTML = function(row){
	if ((row == undefined) || (row.length <= 0)) { return ""; }

	var inputobj = {head:exports.getHeader(row), 
			rows: exports.getData(row)};
	var output = Jaml.render('table', inputobj);

	return output;
}

